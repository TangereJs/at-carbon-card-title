<link rel="import" href="../tangere/tangere.html" />
<link rel="import" href="../at-theme/at-theme.html" />
<link rel="import" href="../at-core-style-classes/at-core-style-classes.html" />
<link rel="import" href="../at-carbon-menu-button/at-carbon-menu-button.html" />
<link rel="import" href="../at-core-activity/at-core-activity.html">

<dom-module id="at-carbon-card-title">
  <template>
    <style include="at-core-style-classes"></style>
    <style>
       :host {
        display: block;
        box-sizing: border-box;
      }

      .flex-container {
        @apply(--layout-horizontal);
      }

      .card-label {
        @apply(--layout-flex);
        @apply(--paper-font-subhead);
        line-height: 40px;
      }

      .menu-button {
        align-self: right;
      }
    </style>
    <div class="flex-container">
      <div class="card-label plsm">[[label]]</div>
      <at-carbon-menu-button id="menuButton" icon="now:more" color="gray" class="menu-button" on-open-changed="_menuButtonOpenChanged" on-value-changed="_onMenuValueChanged" position="[[_computePosition(position)]]" x-offset="-8" y-offset="-8"></at-carbon-menu-button>
    </div>
    <at-core-activity id="api" indicator on-response="_apiCallback"></at-core-activity>
  </template>
</dom-module>
<script>
  Polymer({
    is: "at-carbon-card-title",
    properties: {
      label: {
        type: String,
        value: ""
      },
      revealed: {
        type: Boolean,
        value: false,
        observer: '_revealedChanged'
      },

      position: {
        type: String,
        value: 'top',
        xtype: 'enum',
        xvaluelist: [
          { title: "Top", value: "top" },
          { title: "Bottom", value: "bottom" }
        ]
      }
    },

    $meta: [{
      title: "Card Title",
      type: "element",
      xtype: "at-carbon-card-title",
      icon: "now:more"
    }],

    _computePosition: function(position) {
      // menu position is the inverse of the title position
      if (position === "bottom") {
        return "topRight";
      }
      return "bottomRight";
    },

    _apiCall: function (url,data) {
      var req = this.$.api;
      req.url = url;
      req.body = data;
      req.method = "POST";
      req.contentType = "application/json";
      req.generateRequest();
    },

    _apiCallback: function(e) {
      // currently not really needed
    },

    ready: function() {
      
    },

    _revealedChanged: function(newValue, oldValue) {
      if (!newValue) this.$.menuButton.open = false;
      this.toggleAttribute('hidden', !newValue, this.$.menuButton);
    },

    actionListener: function (event) {
      var model = event.detail.model.state.model;
      this._container = model._container;
      this._card = model._card;
      this.label = this._card.Title;
      this._buildMenu();
    },

    _menuButtonOpenChanged: function (e) {
      // update active state on container     
      this.fire("card-active", e.detail, { bubbles: true });
    },

    _buildMenu: function () {
      var menu = [];

      if (this._container == "now") {
        menu.push(
          { title: "Dismiss", value: "dismiss", icon: "now:wrench" }
        );
      }

      menu.push(
         { title: "Subscribe", value: "subscribe", icon: "now:wrench" }
       );

      // check this._card.UserActions.pinnable ? 
      menu.push(
        { title: "Pin to workplace", value: "pin", icon: "now:pin" }
      );

      this.$.menuButton.items = menu;
    },

    _onMenuValueChanged: function (event) {

      var value = event.detail.value;
      var menuButton = this.$.menuButton;

      if (value == "dismiss") {        
        this.fire('at-core-card-swipe-away', { id: this._card.Id, dir: "menu" });
      }

      if (value == "subscribe") {
        var data = { id: this._card.UserActions.cardId, subscription: false };
        this._apiCall("/api/adenin.GateKeeper.Subscription", data);
      }

      if (value == "pin") {       
        var data = { id: this._card.UserActions.cardId, pinned: true };
        this._apiCall("/api/adenin.Now.UserWorkplaceManager/ChangeStatus", data);
      }

      this.fire('value-changed', {
        value: event.detail.value
      }, {
        bubbles: false
      });

      event.detail.value = "";  // reset selection
      this._buildMenu();        // rebuild menu based on new state
    }
  });
</script>
